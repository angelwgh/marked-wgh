<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no,email=no" />
		<title>商品详情页</title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav transparent-bg">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">商品详情</h1>
			<span id="goodsShare" class="goods-share iconfont icon-fenxiang mui-pull-right"></span>
		</header>
		<div class="mui-content">
		</div>   
		<footer id="goodsBar" class="goods-bar transparent">
	        <div class="action-bar mui-flex">
	            <div class="tocart cell iconfont icon-gouwuche" id="goCart">购物车<span class="plus-one">1</span></div>
	            <button class="end-time" id="endTime" style="display: none;"><span class="iconfont icon-time"></span><em>0</em>天<em>0</em>时<em>0</em>分<em>0</em>秒</button>
	            <button class="cart cell" id="addToCart">加入购物车</button>
	            <button class="buy cell" id="easyBuyBtn">立即购买</button>
	            <button class="nobuy cell" id="noBuy" style="display: none;">已下架</button>
	            <button class="nobuy cell" id="noStock" style="display: none;">已售罄</button>
	            <div class="addfav cell iconfont icon-fav" id="favProduct">收藏</div>
	        </div>
	    </footer>
	    <div class="goods-sku" id="choose"></div>
        <div class="fullCut" id="fullCut"></div>
        <a class="backtop" id="backTop"><span class="mui-icon mui-icon-pulldown"></span></a>
        
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script src="js/md5.js" ></script>
		<script src="js/swiper.min.js"></script>
		<script src="js/mui.zoom.js"></script>
		<script src="js/mui.previewimage.js"></script>
		<script src="js/delayimg.min.js"></script>
		<script src="js/template.js" ></script>
		<script>
			mui.init({
				swipeBack: true,
				beforeback:function(){
					if(!himall.hasClass(content,'transparent') && !document.querySelector('.mui-preview-image.mui-preview-in')){
						content.className+=' transparent';
						goodsBar.className+=' transparent';
						mui.scrollTo(0,0);
						var swiper=document.querySelector('.swiper-wrapper');
						swiper&&(swiper.innerHTML='');
					}
				}
			});
			
			var productId,
				shopId,
				storeId, //门店id
				skuLen,
				skuId,
				stock=0,
				limitBuyMax,
				intDiff,
				limitTime,
				mask,
				w,
				ws,
				fromurl,
				loadPage,
				userkey,
				shareImg,
				shareThumb,
				isOpenLadder,//是否开启阶梯价
				minMath,//最小批量
				isOnLimitBuy,
				isLimitBuyBegin,
				mySwiper;
			var goCart=document.getElementById('goCart'),
				favProduct=document.getElementById('favProduct'),
				addToCart=document.getElementById('addToCart'),
				easyBuyBtn=document.getElementById('easyBuyBtn'),
				noBuy=document.getElementById('noBuy'),
				noStock=document.getElementById('noStock'),
				choose=document.getElementById('choose'),
            	fullCut=document.getElementById('fullCut'),
				endTime=document.getElementById('endTime'),
				content=document.querySelector('.mui-content'),
				goodsBar=document.getElementById('goodsBar'),
				title=document.getElementsByClassName('mui-title')[0],
				backTop=document.getElementById('backTop');
				
				//获取定位
				function getPositionSuccess(position) {
					var lat = position.coords.latitude; //纬度 
					var lon = position.coords.longitude; //经度 
					mui.ajax(TENXUNMAP, {
	                    data: {
	                    	locations: lat+','+lon,
	                    	type: 1,
	                    	key: MAPKEY
	                    },
	                    dataType: 'json',
	                    type: 'get',
	                    timeout: 30000,
	                    success: function (data) {
	                        lat = data.locations[0].lat;
	                        lon = data.locations[0].lng;
	                        fromLatLng = lat+','+lon;
	    					mui.ajax(URL + 'api/product/GetIsSelfDelivery', {
			            		data:himall.md5Data({
										shopId: shopId,
			                            productId: productId,
			                            fromLatLng: fromLatLng,
			                            userkey:himall.getState().userkey
									}),
			                        dataType:'json',
			                        type:'get',
			                        timeout: 10000,
			                        success: function(data){
			                        	if(data.IsSelfDelivery){
			                        		document.querySelector(".goods-service").innerHTML +='<span><i class="iconfont icon-ensure"></i>到店自提</span>';
			                        	}
			                        }
			            	});
	                    }
	                });
				}
				function getIsSelfTake(){
	            	var fromLatLng;
	            	himall.getPosition(getPositionSuccess);
	            }
				
				mui.plusReady(function() {
					ws=plus.webview.currentWebview();
				ws.setStyle({scrollIndicator:'none'});
				loadPage=function(){
					productId = productId.toString().trim();
					userkey=himall.getState().userkey;
					w=plus.nativeUI.showWaiting('',{padlock:true});
					mui.ajax(URL+'api/product/GetProductDetail',{
						data:himall.md5Data({
							id:productId,
							userkey:userkey
						}),
						dataType:'json',
						type:'get',
						timeout:20000,
						success:function(data){
							if(data.success){
								data.IsOnLimitBuy = data.IsOnLimitBuy||fromurl=='limitbuy';
								if(data.Product.ImagePath && data.Product.ImagePath.length>0){
									shareImg=data.Product.ImagePath[0];
								}				
								if(data.Product.ThumbnailPath && data.Product.ThumbnailPath.length>0){
									shareThumb=data.Product.ThumbnailPath[0];
								}
								var service = document.querySelector('.customer-service');
								if(service){
									mui("body").off("tap",".service_list-item");
									mui("body").off("tap",".keng-lb-1");
									service.parentNode.removeChild(service);
								}
								customerService(data.CustomerServices);
								content.innerHTML=template('productInfo', data);
								//document.getElementById("videoSource").src=URL+data.VideoPath;
								
						        var video=document.querySelector('#video1 video');
	                            if(video){
	                            	var loading=function(){
										if(video.currentTime>0){
											siblings(video,'.mui-spinner')[0].style.display='none';
											video.removeEventListener('timeupdate',loading);
										}
									};
									video.addEventListener("timeupdate",function(){
										loading();
							        });
	                            }
														 
								
								isOpenLadder = data.Product.IsOpenLadder;
								minMath = data.Product.MinMath;
								isOnLimitBuy = data.IsOnLimitBuy;
								limitBuyMax=data.MaxSaleCount;
								if(isOpenLadder && !isOnLimitBuy){
									document.getElementById('priceList').innerHTML = template('initPrice', data);
								}
								shopId=data.Shop.Id;
								var slider=document.getElementById('slider');
								if(data.Product.ImagePath.length>0){
									slider.style.height=slider.offsetWidth+'px';
									mySwiper = new Swiper('.swiper-container', {
										pagination: '.swiper-pagination',
										autoplay: 4000,
										speed: 500
									});
									
						            mui.previewImage();
								}
								
								if(data.Color.length>0||data.Size.length>0||data.Version.length>0){
									document.getElementById('chooseSkuBtn').style.display='block';
								}else{
									document.getElementById('chooseSkuBtn').style.display='none';
								}
								
								if(data.Product.CommentCount>0){
									mui.ajax(URL+'api/product/GetProductCommentShow',{
										data:himall.md5Data({
											id:productId
										}),
										dataType:'json',
										type:'get',
										timeout:10000,
										success:function(res){
											document.getElementById('commentList').innerHTML=template('initComment',res.data[0]);
											delayimg.render();
										}
									});
								}
								
								if(data.Product.IsFavorite){
									favProduct.className+=' red';
								}else{
									himall.removeClass(favProduct,' red');
								}
								
								if (himall.ios()) {
									if (!himall.isQQInstalled()&&!himall.isWXInstalled()){
										document.getElementById('goodsShare').style.display='none';
									}
								}
								
								choose.innerHTML=template('skuInfo',data);
								mui('.mui-numbox').numbox();
								skuLen=choose.getElementsByClassName('choose-sku').length;
                              	fullCut.innerHTML=template('fullCutTemplate',data);
								
								mui('#choose').off('tap','.enabled');
								himallSku.setSKUInfo({
									ajaxUrl:'api/product/GetSKUInfo',
									productId:productId,									
									skuLen:skuLen,
									callBack:function(select){
										stock=select.Stock;
										skuId=select.SkuId;
										noStock.style.display = 'none';
									},
									noStockCallBack:function(){
										
										easyBuyBtn.style.display=addToCart.style.display='none';
										if(data.IsOnLimitBuy){
											endTime.className+=' nobuy-time';
											noStock.innerHTML="已售罄";
										}else{											
											noStock.innerHTML="已售罄";
										}
										if(noBuy.style.display.toLocaleLowerCase()=='none'){
											noStock.style.display='block';
										}
									}
								});
								
								//图片延时加载处理
								document.getElementById('ProductDescription').innerHTML=himall.parseDomImg(data.Product.ProductDescription);
								delayimg.init({offset:300,throttle:0});
								mui.previewImage();
								
								//限时购商品处理
								if(data.IsOnLimitBuy){
									title.innerText='限时折扣';
									goCart.style.display=favProduct.style.display=addToCart.style.display='none';
									endTime.style.display='block';
									var st,nt,mi_se,intDiff;
									if (data.NowTime < data.StartDate) {
			                            st = new Date(data.NowTime);
			                            nt = new Date(data.StartDate);
			                            mi_se = nt.getTime() - st.getTime();
			                            intDiff = mi_se / 1000;
			                            easyBuyBtn.className='buy cell limit-btn notbegin';
			                            isLimitBuyBegin = false;
										easyBuyBtn.innerText='即将开始';
			                        }
			                        if (data.NowTime > data.StartDate && data.NowTime < data.EndDate) {
			                            st = new Date(data.NowTime);
			                            nt = new Date(data.EndDate);
			                            mi_se = nt.getTime() - st.getTime();
			                            intDiff = mi_se / 1000;
			                            easyBuyBtn.className='buy cell limit-btn';
			                            isLimitBuyBegin = true;
			                            himall.removeAllClass(endTime,'notbegin');
										easyBuyBtn.innerText='立即抢购';
			                        }
									limitTime=setInterval(function () {
							            var day=0,
							            	hour = 0,
							                minute = 0,
							                second = 0;
							            if (intDiff > 0) {
							            	day = Math.floor(intDiff / (60 * 60 * 24));
							                hour = Math.floor(intDiff / (60 * 60)) - (day * 24);
							                minute = Math.floor(intDiff / 60) - (day * 24 * 60) - (hour * 60);
							                second = Math.floor(intDiff) - (day * 24 * 60 * 60) - (hour * 60 * 60) - (minute * 60);
							                if (minute <= 9) minute = '0' + minute;
								            if (second <= 9) second = '0' + second;
								            endTime.innerHTML='<span class="iconfont icon-time"></span><em>'+day + '</em>天<em>'+hour + '</em>时<em>' + minute + '</em>分<em>' + second+'</em>秒';
								            intDiff--;
							            }else{
							            	window.clearInterval(limitTime);
											skuLen=0;
											loadPage();
							            }
							            
							        }, 1000);
								}else{
									intDiff=0;
									title.innerText='商品详情';
									goCart.style.display=favProduct.style.display=addToCart.style.display='block';
									endTime.style.display='none';
									easyBuyBtn.className='buy cell';
									easyBuyBtn.innerText='立即购买';
								}
								if(data.Product.ProductSaleStatus==2 ||data.Product.AuditStatus!=2){
									easyBuyBtn.style.display=addToCart.style.display='none';
									endTime.className+=' nobuy-time';
									noBuy.style.display='block';
								}else{
									easyBuyBtn.style.display='block';
									if(!data.IsOnLimitBuy){
										addToCart.style.display='block';
									}
									endTime.className='end-time';
									noBuy.style.display='none';
								}
								if(!isLimitBuyBegin){
									endTime.className+=' notbegin';
								}else{
									himall.removeAllClass(endTime,'notbegin');
								}
								
								//拼团处理
								if(data.IsFightGroupActive && data.ActiveStatus==0){
									mui('.mui-content').on('tap', '#goGroup', function() {
							            himall.openVW('merge-detail.html', {activeId: this.getAttribute('data-id')});
							        });
								}else{
									mui('.mui-content').off('tap','#goGroup');
								}
								
								w.close();
								himall.removeClass(content,'transparent');
								himall.removeAllClass(goodsBar,'transparent');
								
								if(!isOpenLadder){
							        //开启授权，显示门店信息
									if (data.IsOpenStore) {
									    LoadStore(data.Product.IsOpenLadder);
									    //显示门店信息
									}
									//获取是否可以到店自提								
	                            	getIsSelfTake();
	                            }
							}else{											
			        			plus.nativeUI.toast(data.msg);
								w.close();
								setTimeout(function(){
								mui.oldBack();
								},1000);								
							}
						},
						error:function(xhr){
							w.close();
							himall.removeClass(content,'transparent');
					        content.innerHTML='<div class="empty-show"><h4>网络不给力，请检查网络！</h4><button id="detailReload" class="mui-btn mui-btn-negative">重新加载</button></div>';
						}
					});
				}
				
				mui('#choose').on('input propertychange', '#porductCount', function(e) {
					if(e.type === "input" || e.orignalEvent.propertyName === "value") {
						checkBuyNum(isOpenLadder);
					}
				});
				mui('#choose').on('tap','#minusbtn',function(){
					checkBuyNum(isOpenLadder);
				});
				mui('#choose').on('tap', '#plusbtn', function() {
					checkBuyNum(isOpenLadder);
				});			
				
				
				mui('.mui-content').on('tap','#detailReload',function(){
					window.clearInterval(limitTime);
					skuLen=0;
					loadPage();
				});
				
				document.addEventListener('updateData',function(e){
					window.clearInterval(limitTime);
					skuLen=0;
					productId=e.detail.productId;
					fromurl=e.detail.url;
					loadPage();
				})
				
				plus.key.addEventListener('backbutton',function(){
					if(choose.className=='goods-sku active'){
						mask.close();
						return false;
					}
				});
				
				himall.stopHref(mui('#ProductDescription'));
			});
			
			var showSkuChoose=function(){
				if(!mask)
					mask = mui.createMask(function(){choose.className='goods-sku';});
				mask.show();
				choose.className+=' active';
			}
			
			var checkBuyNum =function(isOpen) {
				if(isOpen && !isOnLimitBuy){
					var buyNum = document.getElementById('porductCount').value;
					mui.ajax(URL + 'api/product/GetChangeNum', {
						data: himall.md5Data({
							pid: productId,
							buyNum: buyNum,
							userkey:himall.getState().userkey
						}),
						dataType: 'json',
						type: 'get',
						timeout: 10000,
						success: function(data) {
							document.getElementById('pPrice').innerHTML = '¥' + data.price.toFixed(2);
						}
					});
				}
			}
			
			mui.oldBack = mui.back;
			mui.back = function(event) {
				if(choose.className=='goods-sku active'){
					mask.close();
					return false;
				}else
				if(fullCut.className=='fullCut active'){
					maskFullCut.close();
					return false;  
				}else{
					mui.oldBack();
				}
			};
			
			
			goodsBar.addEventListener('tap',function (e) {
				var skuBtn=document.querySelector('.choose-sku-btn'),
					confirmBuy=document.getElementById('confirmBuy'),
					confirmCart=document.getElementById('confirmCart');
				var targetId=e.target.id;
				if(targetId=='addToCart'){
					skuBtn.style.display='none';
					confirmBuy.style.display='none';
					confirmCart.style.display='block';
					showSkuChoose();
				}else if(targetId=='easyBuyBtn'){
					if(isOnLimitBuy&&!isLimitBuyBegin){
						return;
					}
					skuBtn.style.display='none';
					confirmCart.style.display='none';
					confirmBuy.style.display='block';
					showSkuChoose();
				}
			});
			
			mui('.mui-content').on('tap','#chooseSkuBtn',function(){
				document.querySelector('.choose-sku-btn').style.display='block';
				document.getElementById('confirmBuy').style.display='none';
				document.getElementById('confirmCart').style.display='none';
				showSkuChoose();
			});
			
			
			mui('#choose').on('tap','[data-type="cart"]',function(){
				if(himall.isLogin()){
					var len = choose.getElementsByClassName('selected').length;
					if (len === skuLen) {
						setTimeout(function(){
							var count=document.getElementById('porductCount').value;
							if(limitBuyMax){
								if(limitBuyMax<count){
									plus.nativeUI.toast('此商品每人限购'+limitBuyMax);
									return false;
								}
							}
							if(count<=stock){
								var w=plus.nativeUI.showWaiting('',{padlock:true});
								mui.ajax(URL+'api/Cart/PostAddProductToCart',{
									data:himall.md5Data({skuId:skuId,count:count,userkey:himall.getState().userkey}),
									dataType:'json',
									type:'post',
									timeout:10000,
									success:function(data){
										w.close();
										if(data.success){
											mask.close();
											plus.nativeUI.toast('加入购物车成功');
											var plusOne=document.getElementsByClassName('plus-one')[0];
											plusOne.innerText=count;
											plusOne.className='plus-one animate';
											setTimeout(function(){plusOne.className='plus-one';},1000)
											
										}else{
											plus.nativeUI.toast(data.msg);
										}
									},
									error:function(xhr){
										w.close();
										plus.nativeUI.toast('加入购物车失败，请检查网络')
									}
								});
							}else{
								plus.nativeUI.toast('库存不足，当前规格库存为'+stock);
							}
						},100);
					}else{
						plus.nativeUI.toast('请选择商品规格');
					}
				}else{
					showLogin();
				}
			});
			
			mui('#choose').on('tap','[data-type="buy"]',function(){
				if(himall.isLogin()){
					checkPhone(function(){
						var len = choose.getElementsByClassName('selected').length;
						if (len === skuLen) {
							setTimeout(function(){
								var count=document.getElementById('porductCount').value;
								if(isOpenLadder && !isOnLimitBuy){
									if(count < minMath)
									{
										plus.nativeUI.toast('未达商品最小批量，当前最小批量为'+minMath);
										return false;
									}
								}
								if(limitBuyMax){
									if(limitBuyMax<count){
										plus.nativeUI.toast('此商品每人限购'+limitBuyMax);
										return false;
									}
								}
								if(count<=stock){
									mask.close();
									himall.openVW('order-submit.html',{skuIdCount:JSON.stringify({skuId:skuId,count:count})});
								}else{
									plus.nativeUI.toast('库存不足，当前规格库存为'+stock);
								}
							},100);
						}else{
							plus.nativeUI.toast('请选择商品规格');
						}
					});
				}else{
					showLogin();
				}
			});
			
			function checkPhone(callback){
				var w=plus.nativeUI.showWaiting('',{padlock:true});
				mui.ajax(URL+'api/UserCenter/IsConBindSms',{
					data:himall.md5Data({userkey:himall.getState().userkey}),
					dataType:'json',
					type:'post',
					timeout:10000,
					success:function(data){
						w.close();
						if(data.success===false){
							if(data.code==502){
								plus.nativeUI.toast(data.msg);
								himall.setState();
								showLogin();
							}else{
								plus.nativeUI.toast('为了账号安全，购买时需要绑定手机号');
								himall.openVW('bind-phone.html');
							}
						}else{
							callback();
						}
					},
					error:function(xhr){
						w.close();
						plus.nativeUI.toast('请求失败，请检查网络');
					}
				});
			}
			
			document.getElementById("favProduct").addEventListener('tap',function () {
				var _this=this;
				if(himall.isLogin()){
					var w=plus.nativeUI.showWaiting('',{padlock:true});
					mui.ajax(URL+'api/product/PostAddFavoriteProduct',{
						data:himall.md5Data({productId:productId,userkey:himall.getState().userkey}),
						dataType:'json',
						type:'POST',
						timeout:10000,
						success:function(data){
							w.close();
							if(data.success){
								if(himall.hasClass(_this,'red'))
									_this.className=_this.className.replace(' red','');
								else
									_this.className+=' red';
							}
							plus.nativeUI.toast(data.msg);
						},
						error:function(xhr){
							w.close();
							plus.nativeUI.toast('收藏失败，请检查网络')
						}
					});
				}else{
					showLogin();
				}
				
			});
			
			//[弃用]分享链接点击事件[dzy 180329]
			mui(document).on('tap', '#goodsShare', function() {
				var isPromoter = himall.getState().isPromoter;
				var userId = himall.getState().userId;
				var shareurl = URL+'product/detail/'+productId;
				if(userId>0 && isPromoter){
					shareurl = shareurl+"?partnerid="+userId;
				}
				loadShare({
					title:document.getElementById('pName').innerText,
					href:shareurl,
					pictures:shareImg,
					thumbs:shareThumb,
					content:document.getElementById('pShortName')? document.getElementById('pShortName').innerText:document.getElementById('pName').innerText
				});
			});
			
			mui('.mui-content').on('tap', '#goShopCoupon', function() {
				if(himall.isLogin()){
					himall.openVW('vshop-coupon.html',{shopid:this.getAttribute('data-id')});
				}else{
					showLogin({id:'vshop-coupon.html',extras:{shopid:this.getAttribute('data-id')}});
				}
			});
			
			mui('.mui-content').on('tap', '#goods-fullCut', function() {
			    showfullCut();
			});  
			
			mui('#fullCut').on('tap', '.close_fullCut', function() {
			    mui('.fullCut')[0].className='fullCut';  
			    maskFullCut.close();    
			});
			//促销优惠
			var maskFullCut;
			var showfullCut=function(){
				if(!maskFullCut)  
				maskFullCut = mui.createMask(function(){mui('.fullCut')[0].className='fullCut';});
				maskFullCut.show();
				mui('.fullCut')[0].className+=' active';
			}
			
			mui('.mui-content').on('tap', '#goshop', function() {
				var vid = this.getAttribute('data-vshopid');
				if(vid==-1){
					plus.nativeUI.toast('商家暂未开通微店！');
				}else{
					himall.openVW('vshop-detail.html',{vshopId:vid})
				}
			});
			
			mui('.mui-content').on('tap', '#favShop', function() {
				var _this=this;
				if(himall.isLogin()){
					var w=plus.nativeUI.showWaiting('',{padlock:true});
					var shopid=_this.getAttribute('data-shopid');
					mui.ajax(URL+'api/VShop/PostAddFavoriteShop',{
						data: himall.md5Data({
                        	shopId:shopid,
                        	userkey:himall.getState().userkey
                        }),
						dataType:'json',
						type:'POST',
						timeout:10000,
						success:function(data){
							w.close();
							if(_this.innerText=='关注'){
								_this.innerText='已关注';
							}else{
								_this.innerText='关注';
							}
							plus.nativeUI.toast(data.msg);
						},
						error:function(xhr){
							w.close();
							plus.nativeUI.toast('关注失败，请检查网络')
						}
					});
				}else{
					showLogin();
				}
			});
			
			mui('.mui-content').on('tap', '#productComBtn', function() {
				himall.openVW('product-comment.html',{pId:productId});
			});
			mui('body').on('tap', '.storeinfobox', function () {
				himall.openVW('store-home.html', {shopid: storeId,productid:productId});
            });
			mui('body').on('tap', '.j_storelist', function (e) {
				e.stopPropagation();
               	himall.openVW('store-list.html', {fromLatLng:fromLatLng,productId:productId,shopId: shopId});
            });
			
			goCart.addEventListener('tap',function(){
				if(himall.isLogin()){
					himall.openVW('cart-box.html');
				}else{
					showLogin({id:'cart-box.html'});
				}
			});
			
			mui('.mui-content').on('tap','#video1',function(){
            	var video=this.querySelector('video'),
            		btn=this.querySelector('.play-btn'),
            		spinner=this.querySelector('.mui-spinner');
            	if(video.paused){
            		video.play();
            		btn.style.display='none';
            		if(video.currentTime<1){
            			spinner.style.display='block';
            		}
            		mySwiper.stopAutoplay();
            	}else{
            		video.pause();
            		btn.style.display='block';
            		spinner.style.display='none';
            		mySwiper.startAutoplay();
            	}
            });
            
			
			//获取定位
			function getPositionSuccess2(position) {
				var lat = position.coords.latitude; //纬度 
				var lon = position.coords.longitude; //经度 
				mui.ajax(TENXUNMAP, {
                    data: {
                    	locations: lat+','+lon,
                    	type: 1,
                    	key: MAPKEY
                    },
                    dataType: 'json',
                    type: 'get',
                    timeout: 30000,
                    success: function (data) {
                        lat = data.locations[0].lat;
                        lon = data.locations[0].lng;
                        fromLatLng = lat+','+lon;
    					if(fromLatLng==''){
							plus.nativeUI.toast("请在系统设置中打开“定位服务“允许Himall商城获取您的位置");
							return;
						}
	            		mui.ajax(URL + 'api/product/GetStroreInfo', {
			                data: himall.md5Data({
			                    shopId: shopId,
			                    productId:productId,
			                    fromLatLng:fromLatLng
			                }),
			                dataType: 'json',
			                type: 'get',
			                timeout: 30000,
			                success: function (data) {
			                    if (data.success&&data.StoreInfo) {
									document.querySelector(".j_storeName").innerHTML=data.StoreInfo.ShopBranchName;
						            document.querySelector(".j_distanceUnit").innerHTML='('+data.StoreInfo.DistanceUnit+')';
						            document.querySelector(".j_storeAddress").innerHTML=data.StoreInfo.AddressDetail;
						            document.querySelector(".j_storelist").innerHTML='查看全部'+data.total+'家门店';
						            document.querySelector(".j_storesInfo").style.display='block';
						            storeId = data.StoreInfo.Id;
			                    } else {
			                        plus.nativeUI.toast(data.msg)
			                    }
			                }
            			});
                    }
                });
			}
			//门店信息
			function LoadStore(isOpenLadder){
				var fromLatLng = '';
				himall.getPosition(getPositionSuccess2);
			}
			
			
			window.addEventListener('scroll',function(){
				if(document.body.scrollTop>350){
					backTop.style.display='block';
				}else{
					backTop.style.display='none';
				}
			});
			backTop.addEventListener('tap',function(){
				mui.scrollTo(0,100);
			});
			
		</script>
		
		<script id="productInfo" type="text/html">
			<div class="swiper-container product-detail" id="slider">
		        <div class="swiper-wrapper">
		        	{{if VideoPath}}
			        	<div class="swiper-slide" id="video1">
							<video width="100%" height="100%" webkit-playsinline="true"  playsinline="true" style="background: #000;" poster="{{Product.ImagePath[0]}}" loop >
			                    <source src="{{VideoPath}}" id="videoSource" type="video/mp4">
			                </video>
			                <i class="play-btn"></i>
			                <div class="mui-icon mui-spinner mui-spinner-white hidden"></div>
			        	</div>
	                {{/if}}
		        	{{each Product.ImagePath}}
		            	<div class="swiper-slide "><div class="mui-zoom"><img src="{{$value}}" data-preview-src="" data-preview-group="1"></div></div>
		            {{/each}}
		        </div>
		        <div class="swiper-pagination"></div>
	        </div>
		    {{if IsFightGroupActive}}
				{{if ActiveStatus==0}}
				<div id="goGroup" class="pro-type-tip act-ongoing" data-id="{{ActiveId}}">当前商品正在参加拼团活动，点击前往</div>
				{{/if}}
				{{if ActiveStatus==1}}
				<div class="pro-type-tip act-will-start">拼团活动即将开始</div>
				{{/if}}
			{{/if}}
			
			<ul class="mui-table-view table-goods-box">
				<li class="mui-table-view-text">
					<div class="goods-info">						
						{{if Product.IsOpenLadder && !IsOnLimitBuy}}
						<ul >
							<li>
								<p>价格：</p>
								<p>起批量：</p>
							</li>
							<li>
								<ul class="price-list" id="priceList"></ul>
							</li>
						</ul>
						{{else}}
						<p class="p-price"><span>¥ {{IsOnLimitBuy?Product.LimitBuyPrice.toFixed(2):Product.MinSalePrice.toFixed(2)}}</span>{{if Product.MarketPrice>0}}<s>¥{{Product.MarketPrice}}</s>{{/if}}{{if ProductSaleCountOnOff}}<span class="salecount">销量: {{SaleCounts}}</span>{{/if}}</p>
						{{/if}}
						<h3 id="pName">{{Product.ProductName}}</h3>
						{{if Product.ShortDescription}}
							<h4 id="pShortName">{{Product.ShortDescription}}</h4>
						{{/if}}
					</div>
				</li>
				<li class="mui-table-view-text">
					{{if Shop.FreeFreight!=0 || Shop.CouponCount!=0 || BonusCount!=0}}
						<div class="goods-onsale">
							{{if Shop.CouponCount!=0}}
								<p class="goods-coupon" id="goShopCoupon" data-id="{{Shop.Id}}" data-vshopid="{{Shop.VShopId}}"><i>优惠券</i>{{Shop.CouponCount}} 张优惠券<em class="iconfont icon-more"></em></p>
							{{/if}} 
							{{if Shop.FreeFreight!=0 || BonusCount!=0 || (fullDiscount!=null && !IsFightGroupActive)}}  
							    <p id="goods-fullCut" class="fullCut_show"><i>促销优惠</i>
							    <span class="father"> 	
							    {{if Shop.FreeFreight!=0}}
							        <span>满{{Shop.FreeFreight}}免运费 </span>
							    {{/if}}  
							    {{if BonusCount!=0}}
							        <span>满{{BonusGrantPrice}}送{{BonusCount}}个代金红包  </span>
							    {{/if}}
							    {{if fullDiscount!=null && !IsFightGroupActive}}  
							        <span>满{{fullDiscount.Rules[0].Quota.toFixed(2)}}减{{fullDiscount.Rules[0].Discount.toFixed(2)}} </span>
							    {{/if}}
							    </span>
							    <em class="iconfont icon-more"></em></p>
							{{/if}}
						</div>
						<div class="product-address">
							<i class="iconfont icon-address"></i>{{ProductAddress}}<span>{{Free}}</span>
						</div>
					{{/if}}
					<div class="goods-service">
						{{if CashDepositsServer.IsCustomerSecurity}}
							<span><i class="iconfont icon-ensure"></i>消费者保障</span>
						{{/if}}
						{{if CashDepositsServer.IsSevenDayNoReasonReturn}}
							<span><i class="iconfont icon-ensure"></i>七天退换货</span>
						{{/if}}
						{{if CashDepositsServer.IsTimelyShip}}
							<span><i class="iconfont icon-ensure"></i>及时发货</span>
						{{/if}}
					</div>
				</li>
			</ul>
			<ul class="mui-table-view table-goods-box" id="chooseSkuBtn">
				<li class="mui-table-view-text">
					<div class="goods-comment">
						<span>选择规格</span>
						<b class="mui-pull-right"><i class="iconfont icon-more"></i></b>
					</div>
				</li>
			</ul>
			<ul class="mui-table-view table-goods-box j_storesInfo" style="display:none">
				<li class="mui-table-view-text product-store-title">
					<div class="goods-comment storeinfobox">
						 <h1><b class="j_storeName"></b><span class="j_distanceUnit"></span><i class="ic-arrow"></i></h1> 
						 <p class="j_storeAddress"></p>
						 <a class="j_storelist"></a>
					</div>
				</li>
			</ul>
			<ul class="mui-table-view table-goods-box">
				<li class="mui-table-view-text">
					<div class="goods-comment">
						<span>商品评价</span>
						<em class="mui-pull-right"><i class="iconfont icon-daipingjia"></i>{{Product.CommentCount}}</em>
					</div>
				</li>
				<ul class="comment-list" id="commentList"></ul>
			</ul>
			
			<ul class="mui-table-view table-goods-box">
				<li class="mui-table-view-text">
					<div class="goods-shop">
						<img src="{{VShopLog||'images/noimage200.png'}}"/>
						<h4>{{Shop.Name}}</h4>
						<h5>宝贝数量：<span>{{Shop.ProductNum}}</span>关注人数：<span>{{Shop.FavoriteShopCount}}</span></h5>
						<p>
							<span>商品：<em>{{Shop.ProductAndDescription.toFixed(2)}}</em></span>
							<span>发货：<em>{{Shop.SellerDeliverySpeed.toFixed(2)}}</em></span>
							<span>服务：<em>{{Shop.SellerServiceAttitude.toFixed(2)}}</em></span>
						</p>
						<div class="goods-shop-btn">
							<span><a id="goshop" data-vshopid="{{Shop.VShopId}}">进入店铺</a></span>
							<span><a id="favShop" data-shopid="{{Shop.Id}}">{{IsFavoriteShop?'已关注':'关注'}}</a></span>
						</div>
					</div>
				</li>
			</ul>
			<div class="p-detail-more"><span>拖动查看详情</span></div>
			<div class="p-detail mt10">
				<h4>商品图文详情</h4>
				<div class="p-detail-html cl" id="ProductDescription"></div>
			</div>
		</script>
		
		<script id="skuInfo" type="text/html">
			<div class="choose-head border-bot">
				<img id="colorImg" src="{{Product.ImagePath[0]||'images/logo.png'}}">
				<p><em id="pPrice">¥ {{Product.MinSalePrice.toFixed(2)}}</em></p>
				<p>库存 <span id="stock">0</span> {{Product.MeasureUnit}}</p>
			</div>
			<div class="choose-con">
				{{if Color.length>0}}
					<div class="choose-sku">
						<label>{{ColorAlias}}</label>
						<div class="mui-clearfix">
							{{each Color}}
								<span st="0" cid="{{$value.SkuId}}" data-img="{{$value.Img}}" class="enabled">{{$value.Value}}</span>
							{{/each}}
						</div>
					</div>
				{{/if}}
				{{if Size.length>0}}
					<div class="choose-sku">
						<label>{{SizeAlias}}</label>
						<div class="mui-clearfix">
							{{each Size}}
								<span st="1" cid="{{$value.SkuId}}" class="enabled">{{$value.Value}}</span>
							{{/each}}
						</div>
					</div>
				{{/if}}
				{{if Version.length>0}}
					<div class="choose-sku">
						<label>{{VersionAlias}}</label>
						<div class="mui-clearfix">
							{{each Version}}
								<span st="2" cid="{{$value.SkuId}}" class="enabled">{{$value.Value}}</span>
							{{/each}}
						</div>
					</div>
				{{/if}}
				<div class="goods-num">
					<label>数量</label>
					<div id="pMaxCount" class="mui-numbox" data-numbox-min="1">
						<button class="mui-btn mui-numbox-btn-minus" type="button" id="minusbtn">-</button>
						<input id="porductCount" class="mui-numbox-input" type="number" value="1" />
						<button class="mui-btn mui-numbox-btn-plus" type="button" id="plusbtn">+</button>
					</div>
					{{if MaxSaleCount && !Product.IsOpenLadder}}
						<i class="limit-count">同ID限购{{MaxSaleCount}}件</i>
					{{/if}}				
				</div>
			</div>
			<input type="hidden" value="{{Product.IsOpenLadder?1:0}}" id="isOpenLadder" />
			<input type="hidden" value="{{Product.IsOnLimitBuy?1:0}}" id="isOnLimitBuy" />
			<a class="custom-btn" id="confirmCart" data-type="cart">确 定</a>
			<a style="display:none" class="custom-btn" id="confirmBuy" data-type="buy">确 定</a>
			<div class="choose-sku-btn">
				{{if IsOnLimitBuy}}
					<span data-type="buy" style="width: 100%;">立即购买</span>
				{{else}}
					<span data-type="cart">加入购物车</span><span data-type="buy">立即购买</span>
				{{/if}}
			</div>
		</script>
		
		<script type="text/html" id="fullCutTemplate">
			<div class="fullCut_table">
				   {{if Shop.FreeFreight!=0}}
				       <div class="fullCut_table_row">
					 	   <div class="fullCut_table_cell title">满额包邮</div>
					 	   <div class="fullCut_table_cell">
					        <span>满￥{{Shop.FreeFreight}}免运费 </span>
					 	   </div> 
				 	   </div>
				    {{/if}}  
				     {{if fullDiscount!=null}}  
				       <div class="fullCut_table_row">
					        <div class="fullCut_table_cell title">满额减</div>
					 	    <div class="fullCut_table_cell">
					 	    	  {{each fullDiscount.Rules as item i}}  
					               <span>满 ￥{{item.Quota.toFixed(2)}} 减  ￥{{item.Discount.toFixed(2)}}</span>
					              {{/each}} 
					 	    </div>
				 	   </div> 
				    {{/if}} 
				    {{if BonusCount!=0}}
				       <div class="fullCut_table_row">
				        <div class="fullCut_table_cell title">满就送</div>
				 	    <div class="fullCut_table_cell">
				          <span>满￥{{BonusGrantPrice}}元送红包({{BonusCount}}个{{BonusRandomAmountStart}}—{{BonusRandomAmountEnd}}元代金券红包)</span>
				 	    </div> 
				       </div> 
				    {{/if}}
			</div> 
		    <div class="close_fullCut"></div>
		</script>
		<script type="text/html" id="initComment">
			<li class="border-top">
			<h3>{{UserName}}</h3>
			<p>{{ReviewContent}}</p>
			<h5>{{ReviewDate.replace(/-/g,'.').replace('T',' ')}} &nbsp; {{Sku}}</h5>
			{{if Images.length>0}}
				<div class="comment-img cl">
					{{each Images}}
						<div><img src="images/blank.gif" data-delay="{{$value}}" /></div>
					{{/each}}
				</div>
			{{/if}}
			</li>
			<li>
			  <div class="goods-shop-btn">
				<span><a id="productComBtn">查看全部评价</a></span>
		   	</div>
			</li>
		</script>
		<script type="text/html" id="initPrice">
			{{each LadderPrices}}
			<li>
				<p class="p-price">￥{{$value.Price.toFixed(2)}}</p>
				{{if $value.MaxBath == 999999999}}
					<p>≥{{$value.MinBath}} <span class="measureUnit">{{Product.MeasureUnit}}</span></p>
				{{else if $value.MinBath==$value.MaxBath}}
					<p>{{$value.MinBath}}<span class="measureUnit">{{Product.MeasureUnit}}</span></p>
				{{else}}
					<p>{{$value.MinBath}} - {{$value.MaxBath}} <span class="measureUnit">{{Product.MeasureUnit}}</span></p>
				{{/if}}
			</li>
			{{/each}}
		</script>
	</body>

</html>